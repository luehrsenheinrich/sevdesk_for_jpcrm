<?php
/**
 * A class that handles the base operations for interaction with the sevDesk API.
 *
 * @package sdjpcrm
 */

namespace WpMunich\sdjpcrm\SevDesk;
use \WP_Error;

/**
 * Class SevDeskAPI.
 */
class SevDeskAPI {

	/**
	 * The sevdesk api url.
	 *
	 * @var string
	 */
	protected $api_url = 'https://my.sevdesk.de/api/v1/';

	/**
	 * The sevdesk api token.
	 *
	 * @var string
	 */
	protected $api_token = '';

	/**
	 * Object errors array.
	 *
	 * @var array
	 */
	protected $errors = array();

	/**
	 * Constructor.
	 */
	public function __construct() {
		$this->api_token = get_option( 'sevdesk_api_token' );
	}

	/**
	 * Get items from the sevDesk API.
	 *
	 * @see https://5677.extern.sevdesk.dev/apiOverview/index.html#/doc-contacts
	 *
	 * @param  string $object_name The name of the object to fetch from the api.
	 * @param  array  $args        An array of arguments for the api.
	 * @param  bool   $load_all    Load all items from the API, embedded or not.
	 *
	 * @return array       An array of contacts.
	 */
	public function get_items( $object_name, $args = array(), $load_all = false ) {
		$url = add_query_arg(
			$args,
			$this->api_url . $object_name
		);

		$response = wp_remote_request(
			$url,
			array(
				'method'  => 'GET',
				'headers' => array(
					'Authorization' => $this->api_token,
				),
			)
		);

		$data = $this->validate_wp_response( $response );

		if ( is_wp_error( $data ) ) {
			return $data;
		}

		$response_body = json_decode( $data['body'], true );

		$results = array(
			'data' => array(),
		);

		foreach ( $response_body['objects'] as $item ) {
			if ( class_exists( __NAMESPACE__ . '\\models\\' . $item['objectName'] ) ) {
				$class_name = __NAMESPACE__ . '\\models\\' . $item['objectName'];
				$cache_key  = 'sevdesk_' . strtolower( $item['objectName'] ) . '_' . $item['id'];
				wp_cache_set( $cache_key, $item, 'sevdesk' );
				$results['data'][] = new $class_name( $item, $load_all );
			}
		}

		if ( isset( $response_body['total'] ) ) {
			$results['total'] = intval( $response_body['total'] );
		}

		if ( isset( $args['offset'] ) ) {
			$results['offset'] = intval( $args['offset'] );
		}

		if ( isset( $args['limit'] ) ) {
			$results['limit'] = intval( $args['limit'] );
		}

		return $results;
	}

	/**
	 * Validates a response generated by the WP HTTP functions.
	 *
	 * @param  object $response The WP HTTP response.
	 *
	 * @return array|object     A data array or WP_Error
	 */
	protected function validate_wp_response( $response ) {
		if ( ! is_wp_error( $response ) ) {
			// The request went through successfully, check the response code against
			// what we're expecting.
			if ( 200 === wp_remote_retrieve_response_code( $response ) ) {
				// Do something with the response.
				$data = array(
					'body'    => wp_remote_retrieve_body( $response ),
					'headers' => wp_remote_retrieve_headers( $response ),
				);
			} else {
				// The response code was not what we were expecting, record the message.
				$data = new WP_Error( 'sevdesk_api_error', wp_remote_retrieve_response_message( $response ) );
			}
		} else {
			// There was an error making the request.
			$data = new WP_Error( 'sevdesk_api_error', $response->get_error_message() );
		}

		return $data;
	}
}
